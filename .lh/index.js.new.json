{
    "sourceFile": "index.js.new",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1744131294222,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1744131294222,
            "name": "Commit-0",
            "content": "const express = require('express');\r\nconst path = require('path');\r\nconst fs = require('fs');\r\nconst multer = require('multer');\r\nconst axios = require('axios'); // Add axios for API requests\r\nconst marked = require('marked'); // Biblioteka do formatowania markdown\r\nconst { exec, execSync } = require('child_process'); // Dodajemy moduł do wykonywania komend git\r\nrequire('dotenv').config(); // Wczytaj zmienne środowiskowe z pliku .env\r\n\r\nconst app = express();\r\nconst PORT = process.env.PORT || 3000;\r\nconst GEMINI_API_KEY = 'AIzaSyAP1EOpnlAhNRh9MI41v8EHtyRGylNR_bA';\r\nconst GIT_TOKEN = process.env.GIT_TOKEN;\r\nconst GIT_USER = process.env.GIT_USER || 'Yuta1111x';\r\nconst REMOTE_URL = `https://${GIT_USER}:${GIT_TOKEN}@github.com/${GIT_USER}/test.git`;\r\nlet isPushing = false; // Flaga do śledzenia, czy aktualnie trwa push\r\n\r\n// Inicjalizacja konfiguracji git\r\nfunction setupGit() {\r\n  try {\r\n    // Sprawdź, czy katalog jest repozytorium git\r\n    try {\r\n      execSync('git status', { cwd: __dirname });\r\n      console.log('Katalog jest już repozytorium git.');\r\n    } catch (error) {\r\n      console.log('Katalog nie jest repozytorium git. Inicjalizuję nowe repozytorium...');\r\n      execSync('git init', { cwd: __dirname });\r\n      console.log('Repozytorium git zostało zainicjalizowane pomyślnie.');\r\n    }\r\n    \r\n    // Konfiguracja git\r\n    execSync(`git config user.name \"${GIT_USER}\"`);\r\n    execSync(`git config user.email \"${GIT_USER}@users.noreply.github.com\"`);\r\n    const remotes = execSync('git remote').toString();\r\n    if (!remotes.includes('origin')) {\r\n      execSync(`git remote add origin ${REMOTE_URL}`);\r\n      console.log('✅ Remote origin dodany.');\r\n    } else {\r\n      execSync(`git remote set-url origin ${REMOTE_URL}`);\r\n      console.log('✅ Remote origin zaktualizowany.');\r\n    }\r\n  } catch (err) {\r\n    console.error('❌ Błąd przy konfiguracji GIT:', err.message);\r\n  }\r\n}\r\n\r\n// Wywołaj inicjalizację konfiguracji git na starcie\r\nsetupGit();\r\n\r\n// Upewnij się, że istnieje folder temp\r\nconst tempDir = path.join(__dirname, 'temp');\r\nif (!fs.existsSync(tempDir)) {\r\n    fs.mkdirSync(tempDir);\r\n}\r\n\r\n// Configure multer to preserve original filename for file panel\r\nconst storage = multer.diskStorage({\r\n    destination: (req, file, cb) => {\r\n        // Make sure the \"pliki\" directory exists\r\n        const plikiDir = path.join(__dirname, 'pliki');\r\n        if (!fs.existsSync(plikiDir)) {\r\n            fs.mkdirSync(plikiDir);\r\n        }\r\n        cb(null, plikiDir);\r\n    },\r\n    filename: (req, file, cb) => {\r\n        cb(null, file.originalname);\r\n    }\r\n});\r\nconst upload = multer({ storage: storage });\r\n\r\n// Configure multer for temporary image uploads\r\nconst tempStorage = multer.diskStorage({\r\n    destination: (req, file, cb) => {\r\n        cb(null, tempDir);\r\n    },\r\n    filename: (req, file, cb) => {\r\n        cb(null, Date.now() + '-' + file.originalname);\r\n    }\r\n});\r\nconst tempUpload = multer({ storage: tempStorage });\r\n\r\napp.use(express.urlencoded({ extended: true }));\r\napp.use(express.json());\r\napp.use(express.static(path.join(__dirname, 'public'), { index: false }));\r\n\r\n// Modern clean styles\r\nconst modernStyles = `\r\n<style>\r\n    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');\r\n\r\n    * {\r\n        box-sizing: border-box;\r\n        margin: 0;\r\n        padding: 0;\r\n    }\r\n\r\n    :root {\r\n        --bg-dark: #121212;\r\n        --bg-card: #1e1e2d;\r\n        --accent-primary: #6366f1;\r\n        --accent-secondary: #8b5cf6;\r\n        --text-primary: #f3f4f6;\r\n        --text-secondary: #d1d5db;\r\n        --text-muted: #9ca3af;\r\n        --border-color: #2d2d3d;\r\n        --danger: #ef4444;\r\n    }\r\n\r\n    body {\r\n        font-family: 'Inter', sans-serif;\r\n        background: linear-gradient(135deg, #121212 0%, #1a1a2e 100%);\r\n        color: var(--text-primary);\r\n        line-height: 1.6;\r\n        min-height: 100vh;\r\n    }\r\n\r\n    .container {\r\n        width: 90%;\r\n        max-width: 1200px;\r\n        margin: 2rem auto;\r\n        padding: 2rem;\r\n        background: var(--bg-card);\r\n        border-radius: 12px;\r\n        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);\r\n        border: 1px solid var(--border-color);\r\n    }\r\n\r\n    @media (max-width: 767px) {\r\n        .container {\r\n            width: 95%;\r\n            padding: 1.5rem;\r\n            margin: 1rem auto;\r\n        }\r\n    }\r\n\r\n    @media (max-width: 480px) {\r\n        .container {\r\n            width: 98%;\r\n            padding: 1rem;\r\n            margin: 0.5rem auto;\r\n        }\r\n    }\r\n\r\n    h1 {\r\n        text-align: center;\r\n        margin-bottom: 2rem;\r\n        background: linear-gradient(to right, var(--accent-primary), var(--accent-secondary));\r\n        -webkit-background-clip: text;\r\n        -webkit-text-fill-color: transparent;\r\n        font-weight: 700;\r\n        font-size: 2.2rem;\r\n    }\r\n\r\n    @media (max-width: 767px) {\r\n        h1 {\r\n            font-size: 1.8rem;\r\n            margin-bottom: 1.5rem;\r\n        }\r\n    }\r\n\r\n    @media (max-width: 480px) {\r\n        h1 {\r\n            font-size: 1.5rem;\r\n            margin-bottom: 1rem;\r\n        }\r\n    }\r\n\r\n    a {\r\n        text-decoration: none;\r\n    }\r\n\r\n    .btn {\r\n        display: inline-block;\r\n        padding: 0.6rem 1.2rem;\r\n        margin: 0.3rem;\r\n        border: none;\r\n        border-radius: 6px;\r\n        font-weight: 500;\r\n        font-size: 0.9rem;\r\n        cursor: pointer;\r\n        transition: all 0.2s ease;\r\n        text-align: center;\r\n    }\r\n\r\n    @media (max-width: 767px) {\r\n        .btn {\r\n            padding: 0.5rem 0.8rem;\r\n            font-size: 0.8rem;\r\n            margin: 0.2rem;\r\n        }\r\n\r\n        td .btn {\r\n            min-width: 70px;\r\n        }\r\n    }\r\n\r\n    .btn-primary {\r\n        background: linear-gradient(to right, var(--accent-primary), var(--accent-secondary));\r\n        color: white;\r\n    }\r\n\r\n    .btn-secondary {\r\n        background: rgba(255, 255, 255, 0.08);\r\n        color: var(--text-primary);\r\n        border: 1px solid var(--border-color);\r\n    }\r\n\r\n    .btn-danger {\r\n        background: var(--danger);\r\n        color: white;\r\n    }\r\n\r\n    .btn:hover {\r\n        transform: translateY(-2px);\r\n        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);\r\n    }\r\n\r\n    .btn-primary:hover {\r\n        background: linear-gradient(to right, #5254cc, #7e4fdb);\r\n    }\r\n\r\n    .btn-secondary:hover {\r\n        background: rgba(255, 255, 255, 0.12);\r\n    }\r\n\r\n    table {\r\n        width: 100%;\r\n        border-collapse: collapse;\r\n        margin: 1.5rem 0;\r\n        border-radius: 8px;\r\n        overflow-x: auto;\r\n        display: block;\r\n    }\r\n\r\n    @media (min-width: 768px) {\r\n        table {\r\n            display: table;\r\n            overflow-x: hidden;\r\n        }\r\n    }\r\n\r\n    th, td {\r\n        padding: 1rem;\r\n        text-align: left;\r\n        border-bottom: 1px solid var(--border-color);\r\n    }\r\n\r\n    th {\r\n        background-color: rgba(255, 255, 255, 0.05);\r\n        font-weight: 600;\r\n        color: var(--text-primary);\r\n    }\r\n\r\n    tr:hover {\r\n        background-color: rgba(255, 255, 255, 0.03);\r\n    }\r\n\r\n    @media (max-width: 767px) {\r\n        th, td {\r\n            padding: 0.8rem 0.5rem;\r\n        }\r\n\r\n        td.actions {\r\n            display: flex;\r\n            flex-wrap: wrap;\r\n            gap: 0.3rem;\r\n        }\r\n    }\r\n\r\n    input[type=\"text\"],\r\n    input[type=\"file\"] {\r\n        width: 100%;\r\n        padding: 0.8rem;\r\n        margin: 0.8rem 0;\r\n        background: rgba(255, 255, 255, 0.05);\r\n        border: 1px solid var(--border-color);\r\n        border-radius: 6px;\r\n        color: var(--text-primary);\r\n        font-family: 'Inter', sans-serif;\r\n    }\r\n\r\n    @media (max-width: 767px) {\r\n        input[type=\"text\"],\r\n        input[type=\"file\"] {\r\n            padding: 0.7rem;\r\n            margin: 0.6rem 0;\r\n            font-size: 0.9rem;\r\n        }\r\n    }\r\n\r\n    /* Poprawka dla input file na urządzeniach mobilnych */\r\n    @media (max-width: 480px) {\r\n        input[type=\"file\"] {\r\n            padding: 0.5rem;\r\n            font-size: 0.8rem;\r\n        }\r\n\r\n        /* Styl dla kontenera input file w formularzu upload */\r\n        .header-actions form div {\r\n            width: 100%;\r\n        }\r\n    }\r\n\r\n    input[type=\"text\"]:focus,\r\n    input[type=\"file\"]:focus,\r\n    textarea:focus {\r\n        outline: none;\r\n        border-color: var(--accent-primary);\r\n        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);\r\n    }\r\n\r\n    textarea {\r\n        width: 100%;\r\n        height: 70vh;\r\n        min-height: 400px;\r\n        padding: 0.8rem;\r\n        margin: 0.8rem 0;\r\n        background: rgba(255, 255, 255, 0.05);\r\n        border: 1px solid var(--border-color);\r\n        border-radius: 6px;\r\n        color: var(--text-primary);\r\n        font-family: monospace;\r\n        resize: vertical;\r\n    }\r\n\r\n    @media (max-width: 767px) {\r\n        textarea {\r\n            height: 50vh;\r\n            min-height: 300px;\r\n            font-size: 14px;\r\n        }\r\n    }\r\n\r\n    @media (max-width: 480px) {\r\n        textarea {\r\n            height: 40vh;\r\n            min-height: 200px;\r\n            font-size: 13px;\r\n        }\r\n    }\r\n\r\n    form button[type=\"submit\"] {\r\n        background: linear-gradient(to right, var(--accent-primary), var(--accent-secondary));\r\n        color: white;\r\n        padding: 0.8rem 1.5rem;\r\n        border: none;\r\n        border-radius: 6px;\r\n        cursor: pointer;\r\n        font-weight: 500;\r\n        transition: all 0.2s ease;\r\n    }\r\n\r\n    form button[type=\"submit\"]:hover {\r\n        background: linear-gradient(to right, #5254cc, #7e4fdb);\r\n        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);\r\n    }\r\n\r\n    @media (max-width: 767px) {\r\n        form {\r\n            display: flex;\r\n            flex-direction: column;\r\n        }\r\n\r\n        form button[type=\"submit\"] {\r\n            align-self: flex-end;\r\n            padding: 0.7rem 1.2rem;\r\n        }\r\n    }\r\n\r\n    @media (max-width: 480px) {\r\n        form button[type=\"submit\"] {\r\n            align-self: stretch;\r\n            margin-top: 0.5rem;\r\n        }\r\n\r\n        form div[style*=\"justify-content: space-between\"] {\r\n            flex-direction: column;\r\n            gap: 0.5rem;\r\n        }\r\n\r\n        form div[style*=\"justify-content: space-between\"] .btn,\r\n        form div[style*=\"justify-content: space-between\"] button {\r\n            width: 100%;\r\n            margin: 0.2rem 0;\r\n        }\r\n    }\r\n\r\n    .actions {\r\n        display: flex;\r\n        flex-wrap: wrap;\r\n        justify-content: flex-start;\r\n        gap: 0.3rem;\r\n    }\r\n\r\n    .header-actions {\r\n        display: flex;\r\n        justify-content: space-between;\r\n        align-items: center;\r\n        margin-bottom: 1.5rem;\r\n        background: rgba(0, 0, 0, 0.2);\r\n        padding: 1rem;\r\n        border-radius: 8px;\r\n        border: 1px solid var(--border-color);\r\n        flex-wrap: wrap;\r\n        gap: 1rem;\r\n    }\r\n\r\n    @media (max-width: 767px) {\r\n        .header-actions {\r\n            flex-direction: column;\r\n            align-items: stretch;\r\n        }\r\n\r\n        .header-actions > div {\r\n            display: flex;\r\n            flex-wrap: wrap;\r\n            gap: 0.5rem;\r\n        }\r\n\r\n        .header-actions > div .btn {\r\n            flex: 1;\r\n            min-width: 120px;\r\n        }\r\n\r\n        .header-actions form {\r\n            display: flex;\r\n            flex-direction: column;\r\n            gap: 0.5rem;\r\n        }\r\n\r\n        .header-actions form button {\r\n            align-self: stretch;\r\n        }\r\n    }\r\n\r\n    .fade-in {\r\n        animation: fadeIn 0.3s ease forwards;\r\n    }\r\n\r\n    @keyframes fadeIn {\r\n        from { opacity: 0; transform: translateY(10px); }\r\n        to { opacity: 1; transform: translateY(0); }\r\n    }\r\n</style>\r\n`;\r\n\r\napp.get('/', (req, res) => {\r\n    res.send(`\r\n<html>\r\n<head>\r\n    <title>Files Portal</title>\r\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n    ${modernStyles}\r\n</head>\r\n<body>\r\n    <div class=\"container fade-in\">\r\n        <h1>Welcome to Files Portal</h1>\r\n        <div style=\"text-align: center; margin-top: 2rem; display: flex; flex-direction: column; gap: 1rem; align-items: center;\">\r\n            <a href=\"/panel\" class=\"btn btn-primary\">Go to File Management</a>\r\n            <a href=\"/chat\" class=\"btn btn-primary\" style=\"background: linear-gradient(to right, #9333ea, #3b82f6);\">\r\n                <span style=\"display: flex; align-items: center; gap: 8px;\">\r\n                    <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"16\" height=\"16\" fill=\"currentColor\" viewBox=\"0 0 16 16\">\r\n                        <path d=\"M8 1a5 5 0 0 0-5 5v1h1a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V6a6 6 0 1 1 12 0v6a2.5 2.5 0 0 1-2.5 2.5H9.366a1 1 0 0 1-.866.5h-1a1 1 0 1 1 0-2h1a1 1 0 0 1 .866.5H11.5A1.5 1.5 0 0 0 13 12h-1a1 1 0 0 1-1-1V8a1 1 0 0 1 1-1h1V6a5 5 0 0 0-5-5z\"/>\r\n                    </svg>\r\n                    Chat with YutAi\r\n                </span>\r\n            </a>\r\n        </div>\r\n    </div>\r\n</body>\r\n</html>\r\n`);\r\n});\r\n\r\napp.get('/panel', (req, res) => {\r\n    fs.readdir('pliki', (err, files) => {\r\n        if (err) {\r\n            if (err.code === 'ENOENT') {\r\n                // Directory doesn't exist, create it\r\n                fs.mkdirSync('pliki');\r\n                files = [];\r\n            } else {\r\n                return res.send('Error loading files.');\r\n            }\r\n        }\r\n\r\n        const fileRows = files.map(file => `\r\n<tr class=\"fade-in\">\r\n    <td style=\"word-break: break-word; max-width: 200px;\">${file}</td>\r\n    <td class=\"actions\">\r\n            <a href=\"/files/${encodeURIComponent(file)}\" download class=\"btn btn-secondary\">Download</a>\r\n            <a href=\"/panel/edit/${encodeURIComponent(file)}\" class=\"btn btn-secondary\">Edit</a>\r\n            <a href=\"/panel/rename/${encodeURIComponent(file)}\" class=\"btn btn-secondary\">Rename</a>\r\n            <a href=\"/panel/redirect/${encodeURIComponent(file)}\" class=\"btn btn-secondary\">Open</a>\r\n            <a href=\"/panel/delete/${encodeURIComponent(file)}\" class=\"btn btn-danger\">Delete</a>\r\n    </td>\r\n</tr>\r\n`).join('');\r\n\r\n        res.send(`\r\n<html>\r\n<head>\r\n        <title>File Management</title>\r\n        <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n        ${modernStyles}\r\n</head>\r\n<body>\r\n        <div class=\"container fade-in\">\r\n            <h1>File Management</h1>\r\n            \r\n            <div class=\"header-actions\">\r\n                <div>\r\n                    <a href=\"/panel/create\" class=\"btn btn-primary\">Create New File</a>\r\n                    <a href=\"/\" class=\"btn btn-secondary\">Back to Home</a>\r\n                </div>\r\n                <form action=\"/panel/upload\" method=\"post\" enctype=\"multipart/form-data\">\r\n                    <div style=\"display: flex; align-items: center; gap: 10px;\">\r\n                        <input type=\"file\" name=\"file\" required>\r\n                        <button type=\"submit\" class=\"btn btn-primary\">Upload</button>\r\n                    </div>\r\n                </form>\r\n            </div>\r\n\r\n            <table>\r\n                <thead>\r\n                    <tr>\r\n                        <th>File Name</th>\r\n                        <th>Actions</th>\r\n                    </tr>\r\n                </thead>\r\n                <tbody>\r\n                    ${fileRows.length ? fileRows : '<tr><td colspan=\"2\" style=\"text-align: center;\">No files yet. Upload or create a new file.</td></tr>'}\r\n                </tbody>\r\n            </table>\r\n        </div>\r\n</body>\r\n</html>\r\n`);\r\n    });\r\n});\r\n\r\n// Funkcja do wykonywania komend git\r\nfunction pushChanges() {\r\n  if (isPushing) return;\r\n  isPushing = true;\r\n  try {\r\n    execSync('git add *');\r\n    console.log('✅ git add *');\r\n    execSync(`git commit -m \"automat\"`);\r\n    console.log('✅ git commit');\r\n    execSync('git push origin main');\r\n    console.log('✅ git push');\r\n  } catch (err) {\r\n    if (err.message.includes('nothing to commit')) {\r\n      console.log('ℹ️ Brak zmian do zapisania.');\r\n    } else {\r\n      console.error('❌ Błąd przy pushu:', err.message);\r\n    }\r\n  }\r\n  isPushing = false;\r\n}\r\n\r\n// Monitorowanie zmian w folderze pliki\r\nconst plikiDir = path.join(__dirname, 'pliki');\r\nif (!fs.existsSync(plikiDir)) {\r\n    fs.mkdirSync(plikiDir);\r\n}\r\n\r\n// Zmienna do śledzenia ostatniej zmiany, aby uniknąć wielokrotnego wykonania komend dla tej samej zmiany\r\nlet debounceTimer = null;\r\n\r\n// Monitoruj zmiany w folderze pliki\r\nfs.watch(plikiDir, { persistent: true }, (eventType, filename) => {\r\n    if (filename) {\r\n        console.log(`Wykryto zmianę w pliku: ${filename}`);\r\n\r\n        // Użyj debounce, aby uniknąć wielokrotnego wykonania komend dla wielu zmian w krótkim czasie\r\n        clearTimeout(debounceTimer);\r\n        debounceTimer = setTimeout(() => {\r\n            pushChanges();\r\n        }, 2000); // Poczekaj 2 sekundy po ostatniej zmianie\r\n    }\r\n});\r\n\r\nconsole.log(`Monitorowanie zmian w folderze pliki zostało uruchomione.`);\r\n\r\napp.listen(PORT, () => console.log(`Server running on http://localhost:${PORT}`));"
        }
    ]
}